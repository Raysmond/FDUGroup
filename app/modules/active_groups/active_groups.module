<?php
/**
 * Active groups module
 * @author songrenchu, Xiangyan
 */
class active_groups_module extends RModule {

    public $access = array('category/groups/*', 'group/find', 'group/find*');

    /**
     * Override module_content method
     * @return string|void
     */
    public function module_content() {
        $cid = Rays::router()->getParams()[0];

        $groups = array();
        if(isset($cid)&&is_numeric($cid)){
            $category = Category::get($cid);

            if ($category == null) {
                return array();
            }

            $query = Group::find()->join("category")->order_desc("memberCount");
            $subs = $category->children();
            $cidList = array();
            foreach ($subs as $sCat) {
                $cidList[] = $sCat->id;
            }
            $groups = $query->in("categoryId", $cidList)->range(0, 5);
        }
        else{
            $groups = Group::find()->join("category")->order_desc("memberCount")->range(0,5);
        }

        return $this->render('active_groups',['groups'=>$groups]);
    }
}