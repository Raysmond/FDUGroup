<?php
/**
 * Created by PhpStorm.
 * User: songrenchu
 */
class active_groups_module extends RModule {

    public $access = array('category/groups/*', 'group/find', 'group/find*');

    /**
     * Override module_content method
     * @return string|void
     */
    public function module_content() {
        $cid = Rays::router()->getParams()[0];

        $groups = array();
        if(isset($cid)&&is_numeric($cid)){
            $category = Category::get($cid);

            if ($category == null) {
                return array();
            }

            $whereIds = Group::$mapping["categoryId"] . " in (". $cid;
            $subs = $category->children();
            foreach ($subs as $sCat) {
                $whereIds .= ','.$sCat->id;
            }
            $whereIds .= ')';
            unset($subs);

            $groups = Group::find()->join("category")/*->order_desc("memberCount")*/->where($whereIds)->range(0,5);//->where($whereIds)->range(0, 5);
        }
        else{
            $groups = Group::find()->join("category")->order_desc("memberCount")->range(0,5);
        }

        return $this->render('active_groups',['groups'=>$groups]);
    }
}